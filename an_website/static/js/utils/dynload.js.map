{
  "version": 3,
  "sources": ["../../../utils/dynload.ts"],
  "sourcesContent": ["// @license magnet:?xt=urn:btih:0b31508aeb0634b347b8270c7bee4d411b5d4109&dn=agpl-3.0.txt GNU-AGPL-3.0-or-later\n\"use strict\";\nconst bodyDiv = elById(\"body\") as HTMLDivElement;\nlet urlData = {};\n\nconst lastLoaded: [string] | [] = [];\n\ninterface DynloadData {\n    redirect: string;\n    url: string;\n    title: string;\n    body: string;\n    css: string;\n    stylesheets: string[];\n    short_title: string;\n    scripts: { src: string }[];\n    scrollPos?: [number, number];\n}\n\nfunction dynLoadOnData(\n    data: DynloadData,\n    onpopstate: boolean,\n) {\n    if (!data) {\n        console.error(\"No data received\");\n        return;\n    }\n    if (data[\"redirect\"]) {\n        window.location.href = data[\"redirect\"];\n        return;\n    }\n    const url = data[\"url\"];\n    if (!url) {\n        console.error(\"No URL in data \", data);\n        return;\n    }\n    console.log(\"Handling data\", data);\n    if (!onpopstate) {\n        if (lastLoaded.length === 1 && lastLoaded[0] === url) {\n            console.log(\"URL is the same as last loaded, ignoring\");\n            return;\n        }\n        history.pushState(\n            { data: data, url: url, stateType: \"dynLoad\" },\n            data[\"title\"],\n            url,\n        );\n        lastLocation = url;\n    }\n    if (!data[\"body\"]) {\n        window.location.reload();\n        return;\n    }\n\n    /* eslint-disable @typescript-eslint/no-empty-function */\n    // d.onkeyup = () => {}; // not used in any JS file\n    document.onkeydown = () => {}; // remove keydown listeners\n    /* eslint-enable @typescript-eslint/no-empty-function */\n\n    bodyDiv.innerHTML = data[\"body\"];\n    if (data[\"css\"]) {\n        const style = document.createElement(\"style\");\n        style.innerHTML = data[\"css\"];\n        bodyDiv.appendChild(style);\n    }\n    if (data[\"stylesheets\"]) {\n        for (const scriptURL of data[\"stylesheets\"]) {\n            const link = document.createElement(\"link\");\n            link.rel = \"stylesheet\";\n            link.type = \"text/css\";\n            link.href = scriptURL;\n            bodyDiv.appendChild(link);\n        }\n    }\n    if (data[\"scripts\"]) {\n        for (const script of data[\"scripts\"]) {\n            if (script[\"src\"]) {\n                const scriptElement = document.createElement(\"script\");\n                scriptElement.src = script[\"src\"];\n                bodyDiv.appendChild(scriptElement);\n            } else {\n                console.error(\"Script without src\", script);\n            }\n        }\n    }\n\n    if (window[\"hideSitePane\"]) {\n        hideSitePane();\n    }\n\n    document.title = data[\"title\"];\n    const titleElement = elById(\"title\");\n    if (titleElement) {\n        titleElement.setAttribute(\n            \"short_title\",\n            data[\"short_title\"] || data[\"title\"],\n        );\n        titleElement.innerText = data[\"title\"];\n    }\n    dynLoadReplaceAnchors();\n    urlData = data;\n    return true;\n}\n\nfunction dynLoadReplaceAnchors() {\n    for (const anchor of document.getElementsByTagName(\"A\")) {\n        dynLoadReplaceHrefOnAnchor(anchor as HTMLAnchorElement);\n    }\n}\n\nfunction dynLoadReplaceHrefOnAnchor(anchor: HTMLAnchorElement) {\n    if (anchor.hasAttribute(\"no-dynload\")) {\n        return;\n    }\n\n    dynLoadFixHref(anchor);\n}\n\nfunction dynLoadFixHref(anchor: HTMLAnchorElement) {\n    if (anchor.target === \"_blank\") {\n        return;\n    }\n\n    const href = (\n        anchor.href.startsWith(\"/\")\n            ? (window.location.origin + anchor.href)\n            : anchor.href\n    )\n        .trim();\n\n    const hrefWithoutQuery = href.split(\"?\")[0];\n    if (\n        // link is to different domain\n        !href.startsWith(window.location.origin) ||\n        // link is to file, not HTML page\n        (\n            (hrefWithoutQuery.split(\"/\").pop() || \"\").includes(\".\") &&\n            // URLs to redirect page are HTML pages\n            hrefWithoutQuery !== (window.location.origin + \"/redirect\")\n        ) ||\n        // link is to /chat, which redirects to another page\n        hrefWithoutQuery === (window.location.origin + \"/chat\")\n    ) {\n        return;\n    }\n\n    if (\n        // URL to the same page, but with hash\n        href.startsWith(\"#\") ||\n        href.startsWith(window.location.href.split(\"#\")[0] + \"#\")\n    ) {\n        return;\n    }\n\n    // TODO: this is broken because of CSP\n    anchor.onclick = (e) => {\n        dynLoad(href);\n        e.preventDefault();\n    };\n}\n\nfunction dynLoad(url: string) {\n    console.log(\"Loading URL\", url);\n    history.replaceState( // save current scrollPos\n        {\n            data: urlData,\n            url: window.location.href,\n            scrollPos: [\n                document.documentElement.scrollLeft || document.body.scrollLeft,\n                document.documentElement.scrollTop || document.body.scrollTop,\n            ],\n            stateType: \"dynLoad\",\n        },\n        document.title,\n        window.location.href,\n    );\n    dynLoadSwitchToURL(url);\n}\n\nfunction dynLoadSwitchToURL(url: string, allowSameUrl = false) {\n    if (!allowSameUrl && url === window.location.href) {\n        console.log(\"URL is the same as current, just hide site pane\");\n        if (window[\"hideSitePane\"]) {\n            hideSitePane();\n        }\n        return;\n    }\n    bodyDiv.prepend(\n        \"Laden... Wenn dies zu lange (Ã¼ber ein paar Sekunden) dauert, lade bitte die Seite neu.\",\n    );\n    void get(url, \"\", (data) => dynLoadOnData(data, false), (error) => {\n        console.log(error);\n        if (url === window.location.href) {\n            window.location.reload();\n        } else {\n            window.location.href = url;\n        }\n    }, \"application/vnd.asozial.dynload+json\");\n}\n\nfunction dynLoadOnPopState(event: PopStateEvent) {\n    if (event.state) {\n        const state = event.state as DynloadData;\n        console.log(\"Popstate\", state);\n        if (\n            !((event.state as { data: string })[\"data\"] &&\n                dynLoadOnData(state, true))\n        ) {\n            // when the data did not get handled properly\n            dynLoadSwitchToURL(\n                state[\"url\"] || window.location.href,\n                true,\n            );\n        }\n        if (state[\"scrollPos\"]) {\n            window.scrollTo(\n                state[\"scrollPos\"][0],\n                state[\"scrollPos\"][1],\n            );\n            return;\n        }\n    }\n    console.error(\"Couldn't handle state. \", event.state);\n    window.location.reload();\n}\n\nPopStateHandlers[\"dynLoad\"] = dynLoadOnPopState;\n\ndynLoadReplaceAnchors();\n// @license-end\n"],
  "mappings": "aAAA;AAEA,MAAM,QAAU,OAAO,MAAM,EAC7B,IAAI,QAAU,CAAC,EAEf,MAAM,WAA4B,CAAC,EAcnC,SAAS,cACLA,EACAC,EACF,CACE,GAAI,CAACD,EAAM,CACP,QAAQ,MAAM,kBAAkB,EAChC,MACJ,CACA,GAAIA,EAAK,SAAa,CAClB,OAAO,SAAS,KAAOA,EAAK,SAC5B,MACJ,CACA,MAAME,EAAMF,EAAK,IACjB,GAAI,CAACE,EAAK,CACN,QAAQ,MAAM,kBAAmBF,CAAI,EACrC,MACJ,CAEA,GADA,QAAQ,IAAI,gBAAiBA,CAAI,EAC7B,CAACC,EAAY,CACb,GAAI,WAAW,SAAW,GAAK,WAAW,KAAOC,EAAK,CAClD,QAAQ,IAAI,0CAA0C,EACtD,MACJ,CACA,QAAQ,UACJ,CAAE,KAAMF,EAAM,IAAKE,EAAK,UAAW,SAAU,EAC7CF,EAAK,MACLE,CACJ,EACA,aAAeA,CACnB,CACA,GAAI,CAACF,EAAK,KAAS,CACf,OAAO,SAAS,OAAO,EACvB,MACJ,CAQA,GAJA,SAAS,UAAY,IAAM,CAAC,EAG5B,QAAQ,UAAYA,EAAK,KACrBA,EAAK,IAAQ,CACb,MAAMG,EAAQ,SAAS,cAAc,OAAO,EAC5CA,EAAM,UAAYH,EAAK,IACvB,QAAQ,YAAYG,CAAK,CAC7B,CACA,GAAIH,EAAK,YACL,UAAWI,KAAaJ,EAAK,YAAgB,CACzC,MAAMK,EAAO,SAAS,cAAc,MAAM,EAC1CA,EAAK,IAAM,aACXA,EAAK,KAAO,WACZA,EAAK,KAAOD,EACZ,QAAQ,YAAYC,CAAI,CAC5B,CAEJ,GAAIL,EAAK,QACL,UAAWM,KAAUN,EAAK,QACtB,GAAIM,EAAO,IAAQ,CACf,MAAMC,EAAgB,SAAS,cAAc,QAAQ,EACrDA,EAAc,IAAMD,EAAO,IAC3B,QAAQ,YAAYC,CAAa,CACrC,MACI,QAAQ,MAAM,qBAAsBD,CAAM,EAKlD,OAAO,cACP,aAAa,EAGjB,SAAS,MAAQN,EAAK,MACtB,MAAMQ,EAAe,OAAO,OAAO,EACnC,OAAIA,IACAA,EAAa,aACT,cACAR,EAAK,aAAkBA,EAAK,KAChC,EACAQ,EAAa,UAAYR,EAAK,OAElC,sBAAsB,EACtB,QAAUA,EACH,EACX,CAEA,SAAS,uBAAwB,CAC7B,UAAWS,KAAU,SAAS,qBAAqB,GAAG,EAClD,2BAA2BA,CAA2B,CAE9D,CAEA,SAAS,2BAA2BA,EAA2B,CACvDA,EAAO,aAAa,YAAY,GAIpC,eAAeA,CAAM,CACzB,CAEA,SAAS,eAAeA,EAA2B,CAC/C,GAAIA,EAAO,SAAW,SAClB,OAGJ,MAAMC,GACFD,EAAO,KAAK,WAAW,GAAG,EACnB,OAAO,SAAS,OAASA,EAAO,KACjCA,EAAO,MAEZ,KAAK,EAEJE,EAAmBD,EAAK,MAAM,GAAG,EAAE,GAGrC,CAACA,EAAK,WAAW,OAAO,SAAS,MAAM,IAGlCC,EAAiB,MAAM,GAAG,EAAE,IAAI,GAAK,IAAI,SAAS,GAAG,GAEtDA,IAAsB,OAAO,SAAS,OAAS,aAGnDA,IAAsB,OAAO,SAAS,OAAS,SAO/CD,EAAK,WAAW,GAAG,GACnBA,EAAK,WAAW,OAAO,SAAS,KAAK,MAAM,GAAG,EAAE,GAAK,GAAG,IAM5DD,EAAO,QAAWG,GAAM,CACpB,QAAQF,CAAI,EACZE,EAAE,eAAe,CACrB,EACJ,CAEA,SAAS,QAAQV,EAAa,CAC1B,QAAQ,IAAI,cAAeA,CAAG,EAC9B,QAAQ,aACJ,CACI,KAAM,QACN,IAAK,OAAO,SAAS,KACrB,UAAW,CACP,SAAS,gBAAgB,YAAc,SAAS,KAAK,WACrD,SAAS,gBAAgB,WAAa,SAAS,KAAK,SACxD,EACA,UAAW,SACf,EACA,SAAS,MACT,OAAO,SAAS,IACpB,EACA,mBAAmBA,CAAG,CAC1B,CAEA,SAAS,mBAAmBA,EAAaW,EAAe,GAAO,CAC3D,GAAI,CAACA,GAAgBX,IAAQ,OAAO,SAAS,KAAM,CAC/C,QAAQ,IAAI,iDAAiD,EACzD,OAAO,cACP,aAAa,EAEjB,MACJ,CACA,QAAQ,QACJ,wFACJ,EACK,IAAIA,EAAK,GAAKF,GAAS,cAAcA,EAAM,EAAK,EAAIc,GAAU,CAC/D,QAAQ,IAAIA,CAAK,EACbZ,IAAQ,OAAO,SAAS,KACxB,OAAO,SAAS,OAAO,EAEvB,OAAO,SAAS,KAAOA,CAE/B,EAAG,sCAAsC,CAC7C,CAEA,SAAS,kBAAkBa,EAAsB,CAC7C,GAAIA,EAAM,MAAO,CACb,MAAMC,EAAQD,EAAM,MAYpB,GAXA,QAAQ,IAAI,WAAYC,CAAK,EAEtBD,EAAM,MAA2B,MAChC,cAAcC,EAAO,EAAI,GAG7B,mBACIA,EAAM,KAAU,OAAO,SAAS,KAChC,EACJ,EAEAA,EAAM,UAAc,CACpB,OAAO,SACHA,EAAM,UAAa,GACnBA,EAAM,UAAa,EACvB,EACA,MACJ,CACJ,CACA,QAAQ,MAAM,0BAA2BD,EAAM,KAAK,EACpD,OAAO,SAAS,OAAO,CAC3B,CAEA,iBAAiB,QAAa,kBAE9B,sBAAsB,EACtB;",
  "names": ["data", "onpopstate", "url", "style", "scriptURL", "link", "script", "scriptElement", "titleElement", "anchor", "href", "hrefWithoutQuery", "e", "allowSameUrl", "error", "event", "state"]
}
