// @license magnet:?xt=urn:btih:0b31508aeb0634b347b8270c7bee4d411b5d4109&dn=agpl-3.0.txt AGPL-3.0-or-later
export{};const o=document.getElementById("message-input"),p=o.form,y=document.getElementById("message-section"),s=document.getElementById("open-moji-attribution"),c=document.getElementById("connection-state"),l=document.getElementById("current-user"),b=s==null?void 0:s.getAttribute("openmoji-version");let r=100,u=0,i="";const k=e=>new Date(e+16510752e5).toLocaleString(),f=e=>{const t=document.createElement("div");if(s&&s.getAttribute("type")!=="font"){for(const n of e.author)t.append(d(n));t.innerHTML+=": ";for(const n of e.content)t.append(d(n))}else t.innerText="".concat(e.author.join(""),": ").concat(e.content.join(""));t.setAttribute("tooltip",k(e.timestamp)),y.append(t)},I=e=>{if(l.innerHTML="",s&&s.getAttribute("type")!=="font"){for(const t of e)l.append(d(t));return}l.innerText=e.join("")},d=e=>{const t=[...e.length==2&&e[1]==="️"?e[0]:e].map(h=>h.codePointAt(0).toString(16).padStart(4,"0")).join("-").toUpperCase(),n=document.createElement("img"),m="/static/openmoji/svg/".concat(t,".svg");return n.src=b?"".concat(m,"?v=").concat(b):m,n.classList.add("emoji"),n.alt=e,n},v=()=>{i&&!o.value&&(o.value=i,i="")},a=e=>{let t;if(c.onclick=()=>{},e==="connecting")t="Versuche mit WebSocket zu verbinden";else if(e==="connected")t="Mit WebSocket verbunden!";else if(e==="disconnected")t="Verbindung getrennt. Drücke hier um erneut zu versuchen.",c.onclick=()=>{u=0,r=500,c.onclick=()=>{},g()};else{console.error("invalid state",e);return}c.setAttribute("state",e),c.setAttribute("tooltip",t)},M=e=>{const t=JSON.parse(e.data);switch(t.type){case"messages":{y.innerText="";for(const n of t.messages)f(n);break}case"message":{f(t.message);break}case"init":{I(t.current_user),console.log("Connected as",t.current_user.join("")),a("connected"),r=100,u=0;break}case"users":{console.debug("Received users data",t.users);break}case"ratelimit":{v(),alert("Retry after ".concat(t.retry_after," seconds."));break}case"error":{v(),alert(t.error);break}default:console.error("Invalid type ".concat(t.type))}},g=()=>{a("connecting");const e=new WebSocket((window.location.protocol==="https:"?"wss:":"ws:")+"//".concat(window.location.host,"/websocket/emoji-chat")),t=setInterval(()=>{e.send("")},1e4);e.onclose=n=>{if(p.onsubmit=()=>{},n.wasClean){console.debug("Connection closed cleanly, code=".concat(n.code," reason=").concat(n.reason)),a("disconnected");return}if(console.debug("Connection closed, reconnecting in ".concat(r,"ms")),a("connecting"),clearInterval(t),u>20){a("disconnected");return}setTimeout(()=>{r=Math.max(500,Math.floor(Math.min(15e3,1.5*r-200))),u++,g()},r)},e.onopen=n=>{console.debug("Opened WebSocket",n)},e.onmessage=M,p.onsubmit=n=>{o.value!==""&&(i=o.value,e.send(JSON.stringify({type:"message",message:o.value})),o.value=""),n.preventDefault()}};g();// @license-end
//# sourceMappingURL=chat.js.map
